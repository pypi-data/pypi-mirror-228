# SPDX-FileCopyrightText: 2022 Maxwell G <gotmax@e.email>
# SPDX-License-Identifier: GPL-2.0-or-later

---
image: fedora/37
packages:
  - createrepo_c
  - fedora-repos-rawhide
  - mock
  - mock-core-configs
  - rpm-build
sources:
  - https://git.sr.ht/~gotmax23/fedrq
environment:
  CHROOT: "fedora-37"
  nox: ./venv/bin/nox
artifacts:
  - fedrq/results_fedrq.tar.gz
tasks:
  - setup-add-mock-group: |
      sudo usermod -aG mock $USER
  - setup-venv: |
      cd fedrq
      python3 -m venv venv
      ./venv/bin/pip install nox
  - mockbuild-f37: |
      cd fedrq
      $nox -e mockbuild -- --resultdir results_fedrq -r "${CHROOT}-$(rpm -E %_arch)" \
        -a 'https://download.copr.fedorainfracloud.org/results/rpmsoftwaremanagement/dnf5-unstable/fedora-$releasever-$basearch/' \
        --with libdnf5
      tar cvf results_fedrq.tar.gz results_fedrq
  - pytest-py311: |
      cd fedrq
      sudo dnf copr enable -y rpmsoftwaremanagement/dnf5-unstable
      sudo dnf install -y python3-libdnf5
      # Only run the integration tests. Units are run in the RPM build.
      $nox -e dnf_test -- -v -k 'no_rpm_mock' --durations=7
  - typing-py311: |
      cd fedrq
      $nox -e typing
