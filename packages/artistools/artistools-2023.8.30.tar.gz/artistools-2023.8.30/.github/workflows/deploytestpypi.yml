---
name: Upload Package to TestPyPI

on:
    push:
        branches:
            - '*'
        tags:
            - '*'

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0
            - uses: actions/setup-python@v4
              with:
                  cache: pip
                  python-version-file: .python-version
            - name: Install dependencies
              run: |
                  python3 -m pip install --upgrade pip
                  python3 -m pip install -r requirements.txt
                  python3 -m pip install --upgrade setuptools setuptools_scm[toml] wheel twine build

            - name: Build
              run: |
                  python3 -m setuptools_scm
                  python3 setup.py sdist bdist_wheel
                  # python3 -m build --sdist --wheel --outdir dist/ .
                  twine check dist/*

            - name: Publish to Test PyPI
              run: |
                  twine upload --skip-existing --verbose -r testpypi -u __token__ -p ${{ secrets.TESTPYPI_TOKEN }} --non-interactive dist/*
