"use strict";(self.webpackChunkjupyterlab_box_drive=self.webpackChunkjupyterlab_box_drive||[]).push([[611],{611:(e,t,a)=>{a.r(t),a.d(t,{default:()=>h});var n=a(303),i=a(122),o=a(720),s=a(745),r=a(139),d=a(344),l=a(840);class c{constructor(){this._isDisposed=!1,this._fileChanged=new l.Signal(this),this._boxPathMap=new Map([["",{id:"0",isdir:!0}],["/",{id:"0",isdir:!0}]]),this._accessToken=""}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,l.Signal.clearData(this))}set accessToken(e){this._accessToken=e}get name(){return"Box"}get serverSettings(){return r.ServerConnection.makeSettings()}get fileChanged(){return this._fileChanged}async get(e,t){if(!(t&&"content"in t&&t.content)&&this._boxPathMap.has(e))return{name:d.PathExt.basename(e),path:e,last_modified:"",created:"",format:null,mimetype:"",content:null,writable:!0,type:this._boxPathMap.get(e).isdir?"directory":"file"};var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0}),n=await this.get_file_id(e);if(t&&"type"in t&&("file"==t.type||"notebook"==t.type))return this.get_file_content(a,n,e,t);var i=a.folders.get({id:n,params:{fields:"name,item_collection"}}),o=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,cache:"no-store"});if(!o.ok&&404==o.status)return this.get_file_content(a,n,e,t);const s=await o.json(),r=[];for(const t of s.item_collection.entries)if("file"==t.type){var l="file";".ipynb"==d.PathExt.extname(t.name)&&(l="notebook"),r.push({name:t.name,path:this.build_and_set_to_map(e,t.name,t.id,!1),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:l})}else r.push({name:t.name,path:this.build_and_set_to_map(e,t.name,t.id,!0),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:"directory"});return{name:s.name,path:e,last_modified:"",created:"",format:null,mimetype:"",content:r,size:void 0,writable:!0,type:"directory"}}async getDownloadUrl(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e);var n=t.files.getDownloadUrl({id:a}),i=await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"});const o=await i.json();if(!i.ok)throw new Error;return o.download_url}async newUntitled(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let a="";e&&e.path&&(a=e.path);const n=(null==e?void 0:e.type)||"directory";var i="directory"===n?"Untitled Folder":"untitled";const o=(null==e?void 0:e.ext)||"txt",s=new Date;var r,l;const c="directory"===n;if(c)throw new Error("Method not implemented.");for(let e=0;;e++){const n=`${0==e?`${i}`:`${i} ${e}`}${o}`;r=d.PathExt.join(a,n);let c=d.PathExt.dirname(r);var h=new FormData;h.append("parent_id",await this.get_file_id(c));const m=await this.upload_file_content(t,n,"",h,s);if(m.ok||409!=m.status){l=(await m.json()).entries[0],console.log(l);break}}let m={name:l.name,path:this.build_and_set_to_map(a,l.name,l.id,c),created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_created_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"};return this._fileChanged.emit({type:"new",oldValue:null,newValue:m}),m}async delete(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e),n=await t.files.delete({id:a});if(!(await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"})).ok)throw new Error;this.delete_from_map(e)}async rename(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const n=await this.get_file_id(e),i=this.get_file_name(t);let o=d.PathExt.dirname(e);const s=await a.files.updateInfo({id:n,name:i});var r=await fetch(s.url,{method:s.method,headers:s.headers,mode:s.mode,body:s.body,cache:"no-store"});const l=await r.json();return this.build_and_set_to_map(o,i,n,this._boxPathMap.get(e).isdir),{name:i,path:t,created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_modified_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"}}async save(e,t){var a=null==t?void 0:t.format;const n=null==t?void 0:t.content;var i=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let o=d.PathExt.basename(e),s=d.PathExt.dirname(e);var r;"base64"==a?r=await function(e,t="text/plain;charset=UTF-8"){return fetch(`data:${t};base64,`+e).then((e=>e.blob()))}(n):"json"==a?r=JSON.stringify(n,null,2):("text"==a||(a="text"),r=n);var l,c=new FormData;t&&"name"in t?(l=o,c.append("parent_id",await this.get_file_id(s))):(l=this.get_file_name(e),c.append("id",await this.get_file_id(e)));const h=new Date,m=await this.upload_file_content(i,l,r,c,h);console.log(m);const _=await m.json();let p;console.log(_),this._fileChanged.emit({type:"save",oldValue:null,newValue:r});try{var u=await this.get_file_id(e);p=await this.get_file_content(i,u,e,t,h)}catch(t){p={name:l,path:e,created:h.toISOString(),last_modified:h.toISOString(),format:a,mimetype:"",content:null,writable:!0,type:"file"}}return p}async copy(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let n=d.PathExt.basename(e),i=d.PathExt.dirname(e);const o=await this.get_file_id(e),s=await this.get_file_id(t),r=d.PathExt.extname(n),l=n.slice(0,n.length-r.length);for(let e=i===t?1:0;;e++){const n=`${0==e?`${l}`:`${l} ${e}`}${r}`,i=await a.files.copy({id:o,name:n,body:{parent:{id:s}}});var c=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,body:i.body,cache:"no-store"});if(!c.ok&&409==c.status)continue;const d=await c.json(),h=this.build_and_set_to_map(t,n,d.id,!1);return{name:d.name,path:h,last_modified:new Date(d.content_modified_at).toISOString(),created:new Date(d.content_created_at).toISOString(),format:null,mimetype:"",content:"",writable:!0,type:"file"}}}async createCheckpoint(e){return{id:"test",last_modified:(new Date).toISOString()}}async listCheckpoints(e){return[{id:"test",last_modified:(new Date).toISOString()}]}restoreCheckpoint(e,t){return Promise.resolve(void 0)}deleteCheckpoint(e,t){return Promise.resolve(void 0)}async get_file_content(e,t,a,n,i){var o=e.files.get({id:t,params:{fields:["id","name","content_created_at","content_modified_at","extension","item_status","lock","metadata","parent","path_collection","size"].join(",")}}),s=await fetch(o.url,{method:o.method,headers:o.headers,mode:o.mode,cache:"no-store"});const r=await s.json();if(!s.ok)throw new Error;const l=new URL(o.url);var c=[l.protocol,"//",l.host,l.pathname+"/content"].join(""),h=await fetch(c,{method:o.method,headers:o.headers,mode:o.mode,cache:"no-store"});let m,_;m=n&&"type"in n&&n.type?n.type:"file";var p,u,f=h.headers.get("content-type");return null==f?(f="text/plain",_="text"):["ipynb"].includes(r.extension)?(f="",_="json"):["md","yml","yaml","json","py"].includes(r.extension)||["application/x-javascript","image/svg+xml"].includes(f)?(f="text/plain",_="text"):_="application/json"==f?"json":f&&f.split("/")?["text"].includes(f.split("/")[0])?"text":"base64":"text",p="text"==_?await h.text():"notebook"==m.toString()?await h.json():function(e){let t="";const a=new Uint8Array(e);for(let e=0;e<a.byteLength;e++)t+=String.fromCharCode(a[e]);return window.btoa(t)}(await h.arrayBuffer()),u=i?i.toISOString():new Date(r.content_modified_at).toISOString(),{name:r.name,path:d.PathExt.join(a,r.name),created:new Date(r.content_created_at).toISOString(),last_modified:u,format:_,mimetype:f,content:p,writable:!0,type:m}}async upload_file_content(e,t,a,n,i){const o=new File([a],t,{type:"",lastModified:i.getTime()});n.append(t,o);const s=await e.files.upload({body:n});return s.headers&&"Content-Type"in s.headers&&delete s.headers["Content-Type"],await fetch(s.url,{method:s.method,headers:s.headers,body:s.body,mode:s.mode,cache:"no-store"})}async get_file_id(e){var t,a;let n=null===(t=this._boxPathMap.get(e))||void 0===t?void 0:t.id;if(n)return n;let i=d.PathExt.dirname(e);if(!i)return await this.get("",{content:!0}),"0";if(await this.get_file_id(i),await this.get(i,{content:!0}),n=null===(a=this._boxPathMap.get(e))||void 0===a?void 0:a.id,n)return n;throw new Error("ID not found for path")}build_and_set_to_map(e,t,a,n){const i=d.PathExt.join(e,t);return this._boxPathMap.set(i,{id:a,isdir:n}),i}delete_from_map(e){this._boxPathMap.delete(e)}get_file_name(e){return d.PathExt.basename(e)}}const h={id:"jupyterlab-box-drive:plugin",requires:[i.IFileBrowserFactory,o.ITranslator],autoStart:!0,activate:(e,t,a)=>{console.log("JupyterLab extension jupyterlab-box-drive is activated!");const{serviceManager:i}=e,{createFileBrowser:o}=t,r=a.load("jupyterlab-box-drive");!function(e){let t=document.createElement("script");t.setAttribute("src","../extensions/jupyterlab-box-drive/static/BoxSdk.min.js"),t.setAttribute("type","text/javascript"),document.body.appendChild(t)}();const d=new c;i.contents.addDrive(d);const l=o("jp-box-browser",{driveName:d.name,restore:!0});l.title.caption=r.__("Box"),l.title.icon=s.treeViewIcon;const h=new n.ToolbarButton({icon:s.launchIcon,onClick:async()=>{u=window.open("../extensions/jupyterlab-box-drive/static/auth.html","BoxAuth","width=600,height=600")},tooltip:r.__("Log in - Box")});l.toolbar.insertItem(0,"get-token",h),e.shell.add(l,"left");var m,_,p,u=null,f="",w=0;const y=async function(){var e=new FormData;e.append("client_id",_),e.append("client_secret",p),e.append("grant_type","refresh_token"),e.append("refresh_token",f);var t=await fetch(m,{method:"POST",body:e});const a=await t.json();if(!t.ok)throw new Error(a);f=a.refresh_token,w=(new Date).getTime()+1e3*a.expires_in,d.accessToken=a.access_token},g=async function(){try{u&&u.RefreshToken?(m=u.TokenEndpoint,_=u.ClientID,p=u.ClientSecret,f=u.RefreshToken,await y(),u.close(),u=null):f&&w>0&&(new Date).getTime()+6e5>w&&await y()}catch(e){console.error(e)}setTimeout(g,3e3)};g()}}}}]);