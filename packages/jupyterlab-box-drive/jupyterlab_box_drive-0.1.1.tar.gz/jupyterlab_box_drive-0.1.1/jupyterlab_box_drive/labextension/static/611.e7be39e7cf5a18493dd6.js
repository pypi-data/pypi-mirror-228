"use strict";(self.webpackChunkjupyterlab_box_drive=self.webpackChunkjupyterlab_box_drive||[]).push([[611],{611:(e,t,n)=>{n.r(t),n.d(t,{default:()=>h});var a=n(303),i=n(122),o=n(720),s=n(745),r=n(139),d=n(344),l=n(840);class c{constructor(){this._isDisposed=!1,this._fileChanged=new l.Signal(this),this._boxIDMap=new Map([["","0"],["/","0"]]),this._boxDirFileMap=new Map([["",!0],["/",!0]]),this._accessToken=""}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,l.Signal.clearData(this))}set accessToken(e){this._accessToken=e}get name(){return"Box"}get serverSettings(){return r.ServerConnection.makeSettings()}get fileChanged(){return this._fileChanged}async get(e,t){if(!(t&&"content"in t&&t.content)&&this._boxDirFileMap.has(e))return{name:d.PathExt.basename(e),path:e,last_modified:"",created:"",format:null,mimetype:"",content:null,writable:!0,type:this._boxDirFileMap.get(e)?"directory":"file"};var n=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0}),a=await this.get_file_id(e);if(t&&"type"in t&&("file"==t.type||"notebook"==t.type))return this.get_file_content(n,a,e,t);var i=n.folders.get({id:a,params:{fields:"name,item_collection"}}),o=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,cache:"no-store"});if(!o.ok&&404==o.status)return this.get_file_content(n,a,e,t);const s=await o.json(),r=[];for(const t of s.item_collection.entries)if("file"==t.type){var l="file";".ipynb"==d.PathExt.extname(t.name)&&(l="notebook");const n=this.build_path(e,t.name,t.id);r.push({name:t.name,path:n,created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:l}),this._boxDirFileMap.set(n,!1)}else{const n=this.build_path(e,t.name,t.id);r.push({name:t.name,path:n,created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:"directory"}),this._boxDirFileMap.set(n,!0)}return{name:s.name,path:e,last_modified:"",created:"",format:null,mimetype:"",content:r,size:void 0,writable:!0,type:"directory"}}async getDownloadUrl(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const n=await this.get_file_id(e);var a=t.files.getDownloadUrl({id:n}),i=await fetch(a.url,{method:a.method,headers:a.headers,mode:a.mode,cache:"no-store"});const o=await i.json();if(!i.ok)throw new Error;return o.download_url}async newUntitled(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let n="";e&&e.path&&(n=e.path);const a=(null==e?void 0:e.type)||"directory";var i="directory"===a?"Untitled Folder":"untitled";const o=(null==e?void 0:e.ext)||"txt",s=new Date;var r,l;if("directory"===a)throw new Error("Method not implemented.");for(let e=0;;e++){const a=`${0==e?`${i}`:`${i} ${e}`}${o}`;r=d.PathExt.join(n,a);let h=d.PathExt.dirname(r);var c=new FormData;c.append("parent_id",await this.get_file_id(h));const m=await this.upload_file_content(t,a,"",c,s);if(m.ok||409!=m.status){l=(await m.json()).entries[0],console.log(l);break}}let h={name:l.name,path:this.build_path(n,l.name,l.id),created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_created_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"};return this._fileChanged.emit({type:"new",oldValue:null,newValue:h}),h}async delete(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const n=await this.get_file_id(e),a=await t.files.delete({id:n});if(!(await fetch(a.url,{method:a.method,headers:a.headers,mode:a.mode,cache:"no-store"})).ok)throw new Error;this._boxIDMap.delete(e),this._boxDirFileMap.delete(e)}async rename(e,t){var n=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e),i=this.get_file_name(t);let o=d.PathExt.dirname(e);const s=await n.files.updateInfo({id:a,name:i});var r=await fetch(s.url,{method:s.method,headers:s.headers,mode:s.mode,body:s.body,cache:"no-store"});const l=await r.json();return this.build_path(o,i,a),{name:i,path:t,created:new Date(l.content_created_at).toISOString(),last_modified:new Date(l.content_modified_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"}}async save(e,t){var n=null==t?void 0:t.format;const a=null==t?void 0:t.content;var i=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let o=d.PathExt.basename(e),s=d.PathExt.dirname(e);var r;"base64"==n?r=await function(e,t="text/plain;charset=UTF-8"){return fetch(`data:${t};base64,`+e).then((e=>e.blob()))}(a):"json"==n?r=JSON.stringify(a,null,2):("text"==n||(n="text"),r=a);var l,c=new FormData;t&&"name"in t?(l=o,c.append("parent_id",await this.get_file_id(s))):(l=this.get_file_name(e),c.append("id",await this.get_file_id(e)));const h=new Date,m=await this.upload_file_content(i,l,r,c,h);console.log(m);const p=await m.json();let _;console.log(p),this._fileChanged.emit({type:"save",oldValue:null,newValue:r});try{var u=await this.get_file_id(e);_=await this.get_file_content(i,u,e,t,h)}catch(t){_={name:l,path:e,created:h.toISOString(),last_modified:h.toISOString(),format:n,mimetype:"",content:null,writable:!0,type:"file"}}return _}async copy(e,t){var n=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let a=d.PathExt.basename(e),i=d.PathExt.dirname(e);const o=await this.get_file_id(e),s=await this.get_file_id(t),r=d.PathExt.extname(a),l=a.slice(0,a.length-r.length);for(let e=i===t?1:0;;e++){const a=`${0==e?`${l}`:`${l} ${e}`}${r}`,i=await n.files.copy({id:o,name:a,body:{parent:{id:s}}});var c=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,body:i.body,cache:"no-store"});if(!c.ok&&409==c.status)continue;const d=await c.json(),h=this.build_path(t,a,d.id);return{name:d.name,path:h,last_modified:new Date(d.content_modified_at).toISOString(),created:new Date(d.content_created_at).toISOString(),format:null,mimetype:"",content:"",writable:!0,type:"file"}}}async createCheckpoint(e){return{id:"test",last_modified:(new Date).toISOString()}}async listCheckpoints(e){return[{id:"test",last_modified:(new Date).toISOString()}]}restoreCheckpoint(e,t){return Promise.resolve(void 0)}deleteCheckpoint(e,t){return Promise.resolve(void 0)}async get_file_content(e,t,n,a,i){var o=e.files.get({id:t,params:{fields:["id","name","content_created_at","content_modified_at","extension","item_status","lock","metadata","parent","path_collection","size"].join(",")}}),s=await fetch(o.url,{method:o.method,headers:o.headers,mode:o.mode,cache:"no-store"});const r=await s.json();if(!s.ok)throw new Error;const l=new URL(o.url);var c=[l.protocol,"//",l.host,l.pathname+"/content"].join(""),h=await fetch(c,{method:o.method,headers:o.headers,mode:o.mode,cache:"no-store"});let m,p;m=a&&"type"in a&&a.type?a.type:"file";var _,u,f=h.headers.get("content-type");return null==f?(f="text/plain",p="text"):["ipynb"].includes(r.extension)?(f="",p="json"):["md","yml","yaml","json","py"].includes(r.extension)||["application/x-javascript","image/svg+xml"].includes(f)?(f="text/plain",p="text"):p="application/json"==f?"json":f&&f.split("/")?["text"].includes(f.split("/")[0])?"text":"base64":"text",_="text"==p?await h.text():"notebook"==m.toString()?await h.json():function(e){let t="";const n=new Uint8Array(e);for(let e=0;e<n.byteLength;e++)t+=String.fromCharCode(n[e]);return window.btoa(t)}(await h.arrayBuffer()),u=i?i.toISOString():new Date(r.content_modified_at).toISOString(),{name:r.name,path:d.PathExt.join(n,r.name),created:new Date(r.content_created_at).toISOString(),last_modified:u,format:p,mimetype:f,content:_,writable:!0,type:m}}async upload_file_content(e,t,n,a,i){const o=new File([n],t,{type:"",lastModified:i.getTime()});a.append(t,o);const s=await e.files.upload({body:a});return s.headers&&"Content-Type"in s.headers&&delete s.headers["Content-Type"],await fetch(s.url,{method:s.method,headers:s.headers,body:s.body,mode:s.mode,cache:"no-store"})}build_path(e,t,n){const a=d.PathExt.join(e,t);return this._boxIDMap.set(a,n),a}async get_file_id(e){let t=this._boxIDMap.get(e);if(t)return t;let n=d.PathExt.dirname(e);if(!n)return await this.get("",{content:!0}),"0";if(await this.get_file_id(n),await this.get(n,{content:!0}),t=this._boxIDMap.get(e),t)return t;throw new Error("ID not found for path")}get_file_name(e){return d.PathExt.basename(e)}}const h={id:"jupyterlab-box-drive:plugin",requires:[i.IFileBrowserFactory,o.ITranslator],autoStart:!0,activate:(e,t,n)=>{console.log("JupyterLab extension jupyterlab-box-drive is activated!");const{serviceManager:i}=e,{createFileBrowser:o}=t,r=n.load("jupyterlab-box-drive");!function(e){let t=document.createElement("script");t.setAttribute("src","../extensions/jupyterlab-box-drive/static/BoxSdk.min.js"),t.setAttribute("type","text/javascript"),document.body.appendChild(t)}();const d=new c;i.contents.addDrive(d);const l=o("jp-box-browser",{driveName:d.name,restore:!0});l.title.caption=r.__("Box"),l.title.icon=s.treeViewIcon;const h=new a.ToolbarButton({icon:s.launchIcon,onClick:async()=>{u=window.open("../extensions/jupyterlab-box-drive/static/auth.html","BoxAuth","width=600,height=600")},tooltip:r.__("Log in - Box")});l.toolbar.insertItem(0,"get-token",h),e.shell.add(l,"left");var m,p,_,u=null,f="",w=0;const y=async function(){var e=new FormData;e.append("client_id",p),e.append("client_secret",_),e.append("grant_type","refresh_token"),e.append("refresh_token",f);var t=await fetch(m,{method:"POST",body:e});const n=await t.json();if(!t.ok)throw new Error(n);f=n.refresh_token,w=(new Date).getTime()+1e3*n.expires_in,d.accessToken=n.access_token},x=async function(){try{u&&u.RefreshToken?(m=u.TokenEndpoint,p=u.ClientID,_=u.ClientSecret,f=u.RefreshToken,await y(),u.close(),u=null):f&&w>0&&(new Date).getTime()+6e5>w&&await y()}catch(e){console.error(e)}setTimeout(x,3e3)};x()}}}}]);