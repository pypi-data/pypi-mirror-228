"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>A});var n=l(350),i=l(850),s=l(919),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",v="linked-ready-maker",C="ipyflow-slice-self",h="ipyflow-slice-direct",y="ipyflow-slice",f=new Event("cleanup");class g{constructor(){this.comm=null,this.notebook=null,this.session=null,this.isIpyflowCommConnected=!1,this.executionScheduledCells=[],this.selectedCells=[],this.dirtyCells=new Set,this.waitingCells=new Set,this.readyCells=new Set,this.waiterLinks={},this.readyMakerLinks={},this.prevActiveCell=null,this.activeCell=null,this.cellsById={},this.orderIdxById={},this.cellPendingExecution=null,this.isReactivelyExecuting=!1,this.numAltModeExecutes=0,this.altModeExecuteCells=null,this.lastExecutionHighlights=null,this.executedReactiveReadyCells=new Set,this.newReadyCells=new Set,this.forcedReactiveCells=new Set,this.forcedCascadingReactiveCells=new Set,this.numPendingForcedReactiveCounterBumps=0,this.cellParents={},this.cellChildren={},this.settings={},this.lastCellMetadataMap=null}gatherCellMetadataAndContent(){const e={};return this.notebook.widgets.forEach(((t,l)=>{const n=t.model;e[n.id]={index:l,content:n.sharedModel.getSource(),type:n.type}})),e}requestComputeExecSchedule(){this.comm.send({type:"compute_exec_schedule",cell_metadata_by_id:this.gatherCellMetadataAndContent(),is_reactively_executing:this.isReactivelyExecuting})}executeCells(e){if(0===e.length)return;let t=0;for(const l of e)i.CodeCell.execute(l,this.session).then((()=>{var n;(null===(n=l.promptNode.textContent)||void 0===n?void 0:n.includes("[*]"))&&l.setPrompt(""),++t===e.length&&this.requestComputeExecSchedule()}))}toggleReactivity(){return"reactive"===this.settings.exec_mode?this.settings.exec_mode="normal":"normal"===this.settings.exec_mode&&(this.settings.exec_mode="reactive"),this.session.session.kernel.requestExecute({code:"%flow toggle-reactivity",silent:!0,store_history:!1})}bumpForcedReactiveCounter(){return this.numPendingForcedReactiveCounterBumps--,this.session.session.kernel.requestExecute({code:"%flow bump-min-forced-reactive-counter",silent:!0,store_history:!1})}computeTransitiveClosure(e,t=!0,l=!1){const n=new Set;for(const t of e)w(n,t,l?this.cellParents:this.cellChildren);if(!t)for(const t of e)n.delete(t);return Array.from(n).filter((e=>void 0!==this.cellsById[e])).filter((e=>void 0!==this.orderIdxById[e])).sort(((e,t)=>this.orderIdxById[e]-this.orderIdxById[t])).map((e=>this.cellsById[e]))}}const x={};function p(e){delete x[e]}function w(e,t,l){if(e.has(t))return;e.add(t);const n=l[t];void 0!==n&&n.forEach((t=>w(e,t,l)))}function _(e,t){const l={};for(const e in t)l[e]=t[e];for(const t in e)l[t]=e[t];return l}const E={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,n.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,n;const s=t.currentWidget.sessionContext;if(!s.isReady)return;e.commands.execute("notebook:enter-command-mode");const o=null!==(l=x[s.session.id])&&void 0!==l?l:{},c=o.altModeExecuteCells;if(o.altModeExecuteCells=null,null!==(n=o.isIpyflowCommConnected)&&void 0!==n&&n){if(("batch"===o.settings.reactivity_mode||null===c)&&"code"===t.activeCell.model.type)if(o.numAltModeExecutes++,"incremental"===o.settings.reactivity_mode)1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>i.CodeCell.execute(t.activeCell,s))):i.CodeCell.execute(t.activeCell,s);else if("batch"===o.settings.reactivity_mode){let e=null!=c?c:[t.activeCell];"normal"===o.settings.exec_mode&&null===c&&(e=o.computeTransitiveClosure([t.activeCell.model.id])),1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>o.executeCells(e))):o.executeCells(e)}else console.error(`Unknown reactivity mode: ${o.settings.reactivity_mode}`)}else i.CodeCell.execute(t.activeCell,s)}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}});const n=l=>{var n,i;const s=t.currentWidget.sessionContext;if(!s.isReady)return;const o=null!==(n=x[s.session.id])&&void 0!==n?n:{};if(null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return;e.commands.execute("notebook:enter-command-mode");const c=o.computeTransitiveClosure([o.activeCell.model.id],!0,l);o.numPendingForcedReactiveCounterBumps++,"normal"===o.settings.exec_mode?o.executeCells(c):(o.altModeExecuteCells=c,e.commands.execute("alt-mode-execute"))};e.commands.addCommand("execute-forward-slice",{label:"Execute Forward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>n(!1)}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel J"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel ArrowDown"],selector:".jp-Notebook"}),e.commands.addCommand("execute-backward-slice",{label:"Execute Backward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>n(!0)}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel K"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel ArrowUp"],selector:".jp-Notebook"});const o=()=>{var e,l;const n=t.currentWidget.sessionContext;if(!n.isReady)return;const i=null!==(e=x[n.session.id])&&void 0!==e?e:{};if(null!==(l=i.isIpyflowCommConnected)&&void 0!==l&&l){let e=i.executionScheduledCells;i.executionScheduledCells=[],0===e.length&&(e=[i.activeCell.model.id]);const t=i.computeTransitiveClosure(e,!1);t.length>0?i.executeCells(t):i.requestComputeExecSchedule()}};s.NotebookActions.executionScheduled.connect(((e,l)=>{var n,i,s;const o=null==t?void 0:t.currentWidget;if((null==o?void 0:o.content)!==l.notebook)return;const c=null==o?void 0:o.sessionContext;if(null===(n=null==c?void 0:c.isReady)||void 0===n||!n)return;const d=null!==(i=x[c.session.id])&&void 0!==i?i:{};if(null===(s=d.isIpyflowCommConnected)||void 0===s||!s)return;const a=d.settings,r="batch"===(null==a?void 0:a.reactivity_mode),u="reactive"===(null==a?void 0:a.exec_mode);r&&u&&"code"===l.cell.model.type&&d.executionScheduledCells.push(l.cell.model.id)})),e.commands.commandExecuted.connect(((e,l)=>{var n,i,s;const c=null==t?void 0:t.currentWidget,d=null==c?void 0:c.sessionContext;if(null===(n=null==d?void 0:d.isReady)||void 0===n||!n)return;const a=null!==(i=x[d.session.id])&&void 0!==i?i:{};if(null===(s=a.isIpyflowCommConnected)||void 0===s||!s)return;const r=a.settings,u="batch"===(null==r?void 0:r.reactivity_mode),m="reactive"===(null==r?void 0:r.exec_mode);if(u)if("notebook:run-cell"===l.id)m?o():a.requestComputeExecSchedule();else if("notebook:run-cell-and-select-next"===l.id){const e=a.activeCell;try{a.activeCell=a.prevActiveCell,m?o():a.requestComputeExecSchedule()}finally{a.activeCell=e}}})),t.widgetAdded.connect(((e,l)=>{const n=l.sessionContext;let i=()=>p(n.session.id);const s=()=>{n.session.kernel.registerCommTarget("ipyflow-client",((e,s)=>{e.onMsg=e=>{var s;const o=e.content.data;(null===(s=o.success)||void 0===s||s)&&("unestablish"===o.type?i():"establish"===o.type&&(i(),i=M(n,t,l.content)))},i(),i=M(n,t,l.content)}))};n.ready.then((()=>{S(l.content),s(),i(),i=M(n,t,l.content),n.kernelChanged.connect(((e,o)=>{null!=o.newValue&&(S(l.content),i(),p(n.session.id),i=()=>p(n.session.id),n.ready.then((()=>{s(),i=M(n,t,l.content)})))}))}))}))}},R=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},k=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},b=(e,t,l)=>{const n=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",n)};e.addEventListener(t,l),e.addEventListener("cleanup",n)},I=(e,t,l,n,i)=>{null!==e&&null!==t&&b(e,l,(()=>{t.firstElementChild.classList[n](i)}))},L=(e,t)=>{I(R(e),k(e),"mouseover","add",m),I(R(e),k(e),"mouseout","remove",m),I(k(e),R(e),"mouseover","add",t),I(k(e),R(e),"mouseout","remove",t)},S=e=>{e.widgets.forEach((e=>{e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(C),e.node.classList.remove(h),e.node.classList.remove(y);const t=R(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(v),t.dispatchEvent(f));const l=k(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(v),l.dispatchEvent(f))}))},B=(e,t,l,n,i,s,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=v;o.has(e)&&(t=m);const i=n(l[e].node);if(null===i||null===i.firstElementChild)return;i.firstElementChild.classList[s](t)}};e.addEventListener(i,c),b(e,i,c)},M=(e,t,l)=>{var n,s,o;o=e.session.id,x[o]=new g;const f=x[e.session.id];f.activeCell=l.activeCell;const E=e.session.kernel.createComm("ipyflow","ipyflow");f.comm=E,f.notebook=l,f.session=e;let b=!1;const I=e=>{null!==e&&null!==e.model&&(e.model.isDirty?f.dirtyCells.add(e.model.id):f.dirtyCells.delete(e.model.id))},M=c().debounce((()=>{if(b)return void l.model.contentChanged.disconnect(M);const e=f.gatherCellMetadataAndContent();c().isEqual(e,f.lastCellMetadataMap)||(f.lastCellMetadataMap=e,l.widgets.forEach(I),E.send({type:"notify_content_changed",cell_metadata_by_id:e}))}),500),A=(e,t)=>{b?e.stateChanged.disconnect(A):"executionCount"===t.name&&null!==t.newValue&&(f.dirtyCells.delete(e.id),l.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),"incremental"===f.settings.reactivity_mode&&f.requestComputeExecSchedule())};for(const e of l.widgets)e.model.stateChanged.connect(A);const P=(e,t)=>{if(b)l.model.cells.changed.disconnect(P);else if("add"===t.type)for(const e of t.newValues)null==e||e.stateChanged.connect(A);else if("remove"===t.type)for(const e of t.oldValues)null==e||e.stateChanged.disconnect(A)};l.model.cells.changed.connect(P);const j=e=>{let t=-1;l.widgets.forEach(((l,n)=>{l.model.id===e.id&&(t=n)}));const n={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:t};E.send(n)},q=(e,t)=>{var n,i;l===e&&(b?l.activeCellChanged.disconnect(q):(j(t.model),f.prevActiveCell=f.activeCell,f.activeCell=t,null!==f.activeCell&&null!==f.activeCell.model&&"code"===f.activeCell.model.type&&(j(f.activeCell.model),f.dirtyCells.has(f.activeCell.model.id)&&(null===(i=(n=f.activeCell.model)._setDirty)||void 0===i||i.call(n,!0)),F(l))))},T=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],N=(e,t,l,n,i)=>{const s=f.cellsById[e].model;if("code"!==s.type)return;if(null==s.executionCount)return;const o=f.cellsById[e].node;t?o.classList.add(C):o.classList.remove(C),l&&!t?o.classList.add(h):o.classList.remove(h),!n||l||t?o.classList.remove(y):o.classList.add(y),i&&(f.waitingCells.has(e)?(o.classList.add(d),o.classList.add(a),o.classList.remove(u),L(o,m)):f.readyCells.has(e)&&(o.classList.add(u),o.classList.add(a),L(o,v)),"reactive"!==f.settings.exec_mode&&(void 0!==f.waiterLinks[e]&&T.forEach((({action:t,update:l})=>{B(R(o),f.waiterLinks[e],f.cellsById,R,t,l,f.waitingCells),B(k(o),f.waiterLinks[e],f.cellsById,R,t,l,f.waitingCells)})),void 0!==f.readyMakerLinks[e]&&(f.waitingCells.has(e)||(o.classList.add(r),o.classList.add(a)),T.forEach((({action:t,update:l})=>{B(R(o),f.readyMakerLinks[e],f.cellsById,R,t,l,f.waitingCells),B(R(o),f.readyMakerLinks[e],f.cellsById,k,t,l,f.waitingCells)})))))},F=e=>{S(e),(e=>{f.cellsById={},f.orderIdxById={},e.widgets.forEach(((e,t)=>{f.cellsById[e.model.id]=e,f.orderIdxById[e.model.id]=t}))})(e);const t=new Set;let l=new Set,n=f.selectedCells;0===n.length&&(n=[f.activeCell.model.id]);for(const e of n)void 0===f.cellChildren[e]&&void 0===f.cellParents[e]||(l=new Set([e,...l,...f.cellChildren[e],...f.cellParents[e]]),w(t,e,f.cellChildren),t.delete(e),w(t,e,f.cellParents));for(const[e]of Object.entries(f.cellsById))N(e,e===f.activeCell.model.id&&l.has(e),l.has(e),t.has(e),"none"!==f.lastExecutionHighlights)},K=()=>{var e,l,n;b&&t.selectionChanged.disconnect(K);const i=null==t?void 0:t.currentWidget,s=null==i?void 0:i.sessionContext;if(null===(e=null==s?void 0:s.isReady)||void 0===e||!e)return;const o=null!==(l=x[s.session.id])&&void 0!==l?l:{};if(null===(n=o.isIpyflowCommConnected)||void 0===n||!n)return;const c=i.content;o.selectedCells=c.widgets.filter((e=>"code"===e.model.type&&c.isSelected(e))).map((e=>e.model.id)),F(c)};t.selectionChanged.connect(K),E.onMsg=n=>{var s,o,c,d;const a=n.content.data;if(!b&&(null===(s=a.success)||void 0===s||s))if("establish"===a.type)f.isIpyflowCommConnected=!0,l.activeCellChanged.connect(q),l.activeCell.model.stateChanged.connect(A),j(l.activeCell.model),l.model.contentChanged.connect(M),f.requestComputeExecSchedule();else if("set_exec_mode"===a.type)f.numAltModeExecutes=0,f.settings.exec_mode=a.exec_mode;else if("compute_exec_schedule"===a.type){f.settings=a.settings;const n=l.model.getMetadata("ipyflow"),s=null!==(o=null==n?void 0:n.cell_parents)&&void 0!==o?o:{},r=null!==(c=null==n?void 0:n.cell_children)&&void 0!==c?c:{};f.cellParents=_(a.cell_parents,s),f.cellChildren=_(a.cell_children,r),l.model.setMetadata("ipyflow",{cell_parents:f.cellParents,cell_children:f.cellChildren}),t.currentWidget.context.save(),f.waitingCells=new Set(a.waiting_cells),f.readyCells=new Set(a.ready_cells),0===f.numPendingForcedReactiveCounterBumps?(f.forcedReactiveCells=new Set([...f.forcedReactiveCells,...a.forced_reactive_cells]),f.forcedCascadingReactiveCells=new Set([...f.forcedCascadingReactiveCells,...a.forced_cascading_reactive_cells])):(f.forcedReactiveCells=new Set,f.forcedCascadingReactiveCells=new Set),f.waiterLinks=a.waiter_links,f.readyMakerLinks=a.ready_maker_links,f.cellPendingExecution=null;const u=a.exec_mode;f.isReactivelyExecuting=f.isReactivelyExecuting||null!==(d=null==a?void 0:a.is_reactively_executing)&&void 0!==d&&d||"reactive"===u,f.newReadyCells="reactive"===u?new Set([...f.newReadyCells,...a.new_ready_cells]):new Set;const m=a.flow_order,v=a.exec_schedule;f.lastExecutionHighlights=a.highlights;const C=a.last_executed_cell_id;f.executedReactiveReadyCells.add(C);let h=!1;if(a.last_execution_was_error)h=!0;else if("batch"===f.settings.reactivity_mode){const e=f.computeTransitiveClosure(Array.from(f.forcedCascadingReactiveCells).filter((e=>!f.executedReactiveReadyCells.has(e)))).map((e=>e.model.id));let t;t="reactive"===u?f.computeTransitiveClosure([...f.newReadyCells,...f.forcedReactiveCells,...e].filter((e=>!f.executedReactiveReadyCells.has(e)))).filter((e=>!f.executedReactiveReadyCells.has(e.model.id))):[...f.forcedReactiveCells,...e].filter((e=>!f.executedReactiveReadyCells.has(e)&&void 0!==f.cellsById[e]&&void 0!==f.orderIdxById[e])).sort(((e,t)=>f.orderIdxById[e]-f.orderIdxById[t])).map((e=>f.cellsById[e])),0===t.length?h=!0:(f.isReactivelyExecuting=!0,f.executedReactiveReadyCells=new Set([...f.executedReactiveReadyCells,...t.map((e=>e.model.id))]),f.executeCells(t))}else if("incremental"===f.settings.reactivity_mode){let t=!1;for(const e of l.widgets){if(!t&&(t=e.model.id===C,"in_order"===m||"strict"===v))continue;if("code"!==e.model.type||f.executedReactiveReadyCells.has(e.model.id))continue;if(!(f.forcedReactiveCells.has(e.model.id)||f.newReadyCells.has(e.model.id)&&"reactive"===u))continue;const l=e;if(null===f.cellPendingExecution){if(f.cellPendingExecution=l,"in_order"===m||"strict"===v)break}else null==l.model.executionCount||l.model.executionCount<f.cellPendingExecution.model.executionCount&&(f.cellPendingExecution=l)}null===f.cellPendingExecution?h=!0:(f.isReactivelyExecuting=!0,i.CodeCell.execute(f.cellPendingExecution,e))}h&&(f.isReactivelyExecuting&&("reactive"===f.lastExecutionHighlights&&(f.readyCells=f.executedReactiveReadyCells),E.send({type:"reactivity_cleanup"})),f.numAltModeExecutes>0&&0==--f.numAltModeExecutes&&f.toggleReactivity(),f.numPendingForcedReactiveCounterBumps>0&&f.bumpForcedReactiveCounter(),f.forcedReactiveCells=new Set,f.forcedCascadingReactiveCells=new Set,f.newReadyCells=new Set,f.executedReactiveReadyCells=new Set,f.isReactivelyExecuting=!1,F(l))}};const V=l.model.getMetadata("ipyflow");return E.open({interface:"jupyterlab",cell_metadata_by_id:f.gatherCellMetadataAndContent(),cell_parents:null!==(n=null==V?void 0:V.cell_parents)&&void 0!==n?n:{},cell_children:null!==(s=null==V?void 0:V.cell_children)&&void 0!==s?s:{}}),()=>{E.dispose(),b=!0,f.isIpyflowCommConnected=!1,p(e.session.id)}},A=E}}]);